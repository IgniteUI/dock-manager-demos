trigger:
  branches:
    include:
    - master

# This pipeline is meant to build specific branches for deployment. It's not meant to be a part of PR validation.
pr: none

parameters:
- name: isVerbose
  displayName: 'Get verbose output from steps - where configurable'
  type: boolean
  default: false
- name: shouldCleanPostExecution
  displayName: 'Clean all pipeline dirs after the pipeline finishes?'
  type: boolean
  default: true


name: $(Year:yyyy).$(Month).$(DayOfMonth)-r$(Rev:.r)

stages:
- stage: Build
  pool:
    vmImage: ubuntu-latest

    demands: npm
  jobs:
  - job: BuildSamples
    steps:
      - checkout: 'self' 
        clean: true

      - task: NodeTool@0
        displayName: 'Install Node'
        inputs:
          versionSource: 'spec'
          versionSpec: '20.x'

      - task: Npm@1
        displayName: 'Register licensed npm registry in .npmrc'
        inputs:
          verbose: ${{ parameters.isVerbose }}
          command: 'custom'
          workingDir: '$(Build.SourcesDirectory)'
          customCommand: 'config -L project set @infragistics:registry=https://packages.infragistics.com/npm/js-licensed/'
      - task: npmAuthenticate@0
        displayName: '[IG Production ProGet] npm authenticate'
        inputs:
          workingFile: '$(Build.SourcesDirectory)/.npmrc'
          customEndpoint: 'public proget'

      - task: Npm@1
        displayName: 'Npm install'
        inputs:
          workingDir: '$(Build.SourcesDirectory)/projects/stream-manager'
          command: 'install'

      - task: Npm@1
        displayName: 'npm run build:ci'
        inputs:
          command: custom
          workingDir: '$(Build.SourcesDirectory)/projects/stream-manager'
          verbose: ${{ parameters.isVerbose }}
          customCommand: 'build'

      - task: PublishPipelineArtifact@1

        displayName: 'Publish app'
        inputs:
          targetPath: '$(Build.SourcesDirectory)/dist'
          artifact: 'dist'
          publishLocation: 'pipeline'

      - ${{ if eq(parameters.shouldCleanPostExecution, true) }}:
        - task: PostBuildCleanup@4
